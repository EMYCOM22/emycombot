<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Configurar Bot - Emycom Play</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .online {
            background: #d4edda;
            color: #155724;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        .offline {
            background: #f8d7da;
            color: #721c24;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        .tab {
            padding: 12px 25px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab.active {
            background: #667eea;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .commands-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .command-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .command-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }
        .command-resposta {
            color: #666;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin: 0 5px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-edit { background: #ffc107; color: #333; }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        textarea { min-height: 150px; }
        .checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        .editor-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px; /* Agora est√° em cima, ent√£o margin-bottom */
            border: 2px solid #667eea;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .badge-modo {
            background: #e3f2fd;
            color: #0d47a1;
        }
        .badge-ativo {
            background: #d4edda;
            color: #155724;
        }
        .badge-inativo {
            background: #f8d7da;
            color: #721c24;
        }
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span>‚öôÔ∏è Configurar Bot WhatsApp</span>
        </h1>

        <div class="status-bar" id="statusBar">
            <span>Status do Bot:</span>
            <span id="botStatus" class="offline">üî¥ Offline</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="openTab('comandos')">üìã Comandos</div>
            <div class="tab" onclick="openTab('testes')">üß™ Testes IPTV</div>
            <div class="tab" onclick="openTab('bloqueio')">üîí Bloqueio</div>
        </div>

        <!-- ABA COMANDOS -->
        <div id="tab-comandos" class="tab-content active">
            <div class="header-actions">
                <h2>Comandos do Bot</h2>
                <button class="btn btn-success" onclick="novoComando()">+ Novo Comando</button>
            </div>

            <!-- EDITOR DE COMANDO (AGORA NO TOPO) -->
            <div id="editorComando" class="editor-card" style="display: none;">
                <h3 id="editorTitulo">‚ûï Novo Comando</h3>
                <input type="text" id="cmdNome" placeholder="Nome do comando (ex: oi, menu, teste)">
                <textarea id="cmdResposta" rows="4" placeholder="Digite a resposta do bot..."></textarea>
                
                <!-- MODO DE CORRESPOND√äNCIA -->
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;"><strong>Modo de correspond√™ncia:</strong></label>
                    <select id="cmdModo" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="escrita_exata">üîµ Escrita exata (digitar exatamente)</option>
                        <option value="contem">üü¢ Cont√©m a palavra</option>
                        <option value="comeca_com">üü° Come√ßa com</option>
                        <option value="termina_com">üü† Termina com</option>
                    </select>
                    <small style="color: #666;">Defina como o bot deve interpretar este comando</small>
                </div>
                
                <div class="checkbox">
                    <input type="checkbox" id="cmdAtivo" checked>
                    <label>Comando ativo</label>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="salvarComando()">üíæ Salvar</button>
                    <button class="btn btn-danger" onclick="cancelarEdicao()">‚úñ Cancelar</button>
                </div>
            </div>

            <!-- LISTA DE COMANDOS (AGORA ABAIXO) -->
            <div id="listaComandos" class="commands-list">
                Carregando...
            </div>
        </div>

        <!-- ABA TESTES -->
        <div id="tab-testes" class="tab-content">
            <h2>Configura√ß√µes de Teste</h2>
            <div id="configTestes">
                <p>Carregando configura√ß√µes...</p>
            </div>
        </div>

        <!-- ABA BLOQUEIO -->
        <div id="tab-bloqueio" class="tab-content">
            <h2>üîí Configura√ß√£o de Bloqueio</h2>
            <div id="configBloqueio">
                <p>Carregando configura√ß√µes...</p>
            </div>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let configAtual = { comandos: {} };

        // ========== CARREGAR COMANDOS ==========
        async function carregarComandos() {
            try {
                const res = await fetch('/api/bot/comandos');
                configAtual.comandos = await res.json();
                
                let html = '';
                for (let [nome, dados] of Object.entries(configAtual.comandos)) {
                    const modoTexto = {
                        'escrita_exata': 'üîµ Escrita exata',
                        'contem': 'üü¢ Cont√©m',
                        'comeca_com': 'üü° Come√ßa com',
                        'termina_com': 'üü† Termina com'
                    }[dados.modo] || 'üîµ Escrita exata';
                    
                    html += `
                        <div class="command-item">
                            <div class="command-header">
                                <span class="command-name">/${nome}</span>
                                <div>
                                    <button class="btn btn-edit" onclick="editarComando('${nome}')">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-danger" onclick="deletarComando('${nome}')">üóëÔ∏è Excluir</button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <span class="badge badge-modo">${modoTexto}</span>
                                <span class="badge ${dados.ativo ? 'badge-ativo' : 'badge-inativo'}">
                                    ${dados.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}
                                </span>
                            </div>
                            <div class="command-resposta">${(dados.resposta || '').replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
                
                if (Object.keys(configAtual.comandos).length === 0) {
                    html = '<p style="color: #666; padding: 20px;">Nenhum comando cadastrado. Clique em "+ Novo Comando" para come√ßar.</p>';
                }
                
                document.getElementById('listaComandos').innerHTML = html;
                
            } catch (error) {
                document.getElementById('listaComandos').innerHTML = '<p style="color: #dc3545;">Erro ao carregar comandos.</p>';
            }
        }

        // ========== CARREGAR STATUS DO BOT ==========
        async function carregarStatus() {
            try {
                const res = await fetch('/api/bot/status');
                const status = await res.json();
                
                const el = document.getElementById('botStatus');
                if (status.online) {
                    el.innerHTML = 'üü¢ Online';
                    el.className = 'online';
                } else {
                    el.innerHTML = 'üî¥ Offline';
                    el.className = 'offline';
                }
            } catch (error) {
                console.error('Erro ao carregar status');
            }
        }

        // ========== EDITAR COMANDO ==========
        async function editarComando(nome) {
            const res = await fetch(`/api/bot/comandos/${nome}`);
            const cmd = await res.json();
            
            document.getElementById('editorComando').style.display = 'block';
            document.getElementById('editorTitulo').innerHTML = `‚úèÔ∏è Editando: ${nome}`;
            document.getElementById('cmdNome').value = nome;
            document.getElementById('cmdNome').readOnly = true;
            document.getElementById('cmdResposta').value = cmd.resposta || '';
            document.getElementById('cmdModo').value = cmd.modo || 'escrita_exata';
            document.getElementById('cmdAtivo').checked = cmd.ativo !== false;
            
            // Rolar suavemente at√© o editor
            document.getElementById('editorComando').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== NOVO COMANDO ==========
        function novoComando() {
            document.getElementById('editorComando').style.display = 'block';
            document.getElementById('editorTitulo').innerHTML = '‚ûï Novo Comando';
            document.getElementById('cmdNome').value = '';
            document.getElementById('cmdNome').readOnly = false;
            document.getElementById('cmdResposta').value = '';
            document.getElementById('cmdModo').value = 'escrita_exata';
            document.getElementById('cmdAtivo').checked = true;
            
            // Rolar suavemente at√© o editor
            document.getElementById('editorComando').scrollIntoView({ behavior: 'smooth' });
            
            // Focar no campo nome
            document.getElementById('cmdNome').focus();
        }

        // ========== SALVAR COMANDO ==========
        async function salvarComando() {
            const nome = document.getElementById('cmdNome').value.trim();
            const resposta = document.getElementById('cmdResposta').value.trim();
            const modo = document.getElementById('cmdModo').value;
            const ativo = document.getElementById('cmdAtivo').checked;
            
            if (!nome || !resposta) {
                alert('Preencha todos os campos!');
                return;
            }
            
            const res = await fetch(`/api/bot/comandos/${nome}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ resposta, modo, ativo })
            });
            
            if (res.ok) {
                alert('‚úÖ Comando salvo com sucesso!');
                document.getElementById('editorComando').style.display = 'none';
                carregarComandos();
            } else {
                alert('‚ùå Erro ao salvar comando');
            }
        }

        // ========== DELETAR COMANDO ==========
        async function deletarComando(nome) {
            if (confirm(`Tem certeza que deseja deletar o comando "${nome}"?`)) {
                const res = await fetch(`/api/bot/comandos/${nome}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    alert('‚úÖ Comando removido!');
                    carregarComandos();
                }
            }
        }

        // ========== CANCELAR EDI√á√ÉO ==========
        function cancelarEdicao() {
            document.getElementById('editorComando').style.display = 'none';
        }

        // ========== TROCAR ABAS ==========
        function openTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'comandos') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('tab-comandos').classList.add('active');
            } else if (tab === 'testes') {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('tab-testes').classList.add('active');
                carregarTestes();
            } else if (tab === 'bloqueio') {
                document.querySelectorAll('.tab')[2].classList.add('active');
                document.getElementById('tab-bloqueio').classList.add('active');
                carregarBloqueio();
            }
        }

        // ========== FUN√á√ïES DE TESTE ==========
        async function carregarTestes() {
            document.getElementById('configTestes').innerHTML = '<p>Configura√ß√µes de teste ser√£o carregadas aqui...</p>';
        }

        // ========== FUN√á√ïES DE BLOQUEIO ==========
        async function carregarBloqueio() {
            document.getElementById('configBloqueio').innerHTML = '<p>Configura√ß√µes de bloqueio ser√£o carregadas aqui...</p>';
        }

        // ========== INICIALIZAR ==========
        document.addEventListener('DOMContentLoaded', () => {
            carregarComandos();
            carregarStatus();
            setInterval(carregarStatus, 5000);
        });
    </script>
</body>
</html>